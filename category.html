<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Category - Hemaavathi Fashions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link 
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" 
    rel="stylesheet" 
  />
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
  />
  <style>
    /* Additional styles for subcategory and filters */
    .subcategory-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 16px 0;
      justify-content: center;
    }
    .subcategory-btn {
      padding: 8px 22px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .subcategory-btn.selected,
    .subcategory-btn:hover {
      background: var(--accent);
      color: var(--text);
    }
  
    .filter-sort-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      margin: 24px 0;
      align-items: center;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-group label {
      font-weight: 600;
      margin-right: 8px;
    }
    select, input[type=checkbox] {
      cursor: pointer;
    }
    .size-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 300px;
    }

    /* Product grid adjustment to show filtered products */
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Hemaavathi Fashions Logo" class="logo" width="160" height="85" />
    <nav class="navbar" aria-label="Primary navigation">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="policy.html">Policies</a>
    </nav>
  </header>

  <main class="main-content">
    <section class="category-header" aria-label="Category header">
      <h1 id="category-title">Loading...</h1>
      <p id="category-description"></p>
    </section>

    <nav class="subcategory-nav" id="subcategory-nav" aria-label="Subcategory navigation">
      <!-- Subcategory buttons will be inserted here -->
    </nav>

    <section class="filter-sort-bar" aria-label="Sorting and filtering options">
      <div class="filter-group" aria-label="Size filter">
        <label>Filter by size:</label>
        <div class="size-filters" id="size-filters">
          <!-- Size checkbox filters inserted here -->
        </div>
      </div>

      <div class="filter-group" aria-label="Sort products">
        <label for="sort-select">Sort by:</label>
        <select id="sort-select">
          <option value="default">-- Default --</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="name-asc">Name: A-Z</option>
          <option value="name-desc">Name: Z-A</option>
        </select>
      </div>
    </section>

    <section id="product-list" class="product-grid" aria-live="polite" aria-label="Product list">
      <!-- Products will be dynamically inserted here -->
    </section>
  </main>

  <footer>
    <nav class="footer-links" aria-label="Footer navigation">
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="policy.html">Policies</a>
      <a href="https://wa.me/919492324225" target="_blank" rel="noopener noreferrer">WhatsApp</a>
    </nav>

    <nav class="footer-social" aria-label="Social media links">
      <a href="https://instagram.com/hemaavathi__fashions" target="_blank" rel="noopener noreferrer" aria-label="Instagram"
        ><i class="fab fa-instagram"></i
      ></a>
      <a href="https://facebook.com/profile.php?id=61574970737394" target="_blank" rel="noopener noreferrer" aria-label="Facebook"
        ><i class="fab fa-facebook-f"></i
      ></a>
      <a href="https://youtube.com/@Hemaavathifashions" target="_blank" rel="noopener noreferrer" aria-label="YouTube"
        ><i class="fab fa-youtube"></i
      ></a>
    </nav>
    <div style="margin-top: 18px; font-size: 0.9em;">&copy; 2025 Hemaavathi Fashions</div>
  </footer>

  <script>
    // Utilities
    function getCategoryFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('category') || location.search.slice(1) || '';
    }

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${product.image}" alt="${product.name}" loading="lazy" />
        <div class="prod-info">
          <span class="prod-name">${product.name}</span><br />
          <span class="prod-price">â‚¹${product.price}</span>
          ${product.sizes ? `<br/><small>Sizes: ${product.sizes.join(', ')}</small>` : ''}
        </div>`;
      return card;
    }

    function flattenSizes(products) {
      // Return set of all sizes available among products
      const sizesSet = new Set();
      products.forEach(p => {
        if (Array.isArray(p.sizes)) p.sizes.forEach(s => sizesSet.add(s));
      });
      return Array.from(sizesSet).sort();
    }

    // Global variables to keep track of state
    let allProducts = [];
    let categoryHeaders = {};
    let subCategories = {};
    let currentCategory = '';
    let currentSubCategory = '';
    let selectedSizes = new Set();
    let currentSort = 'default';

    // Render subcategories buttons
    function renderSubcategories() {
      const container = document.getElementById('subcategory-nav');
      container.innerHTML = '';

      if (!subCategories[currentCategory]) return;
      const subs = Object.keys(subCategories[currentCategory]);
      if (!subs.length) return;

      // Add an "All" button to reset subcategory filter
      const allBtn = document.createElement('button');
      allBtn.textContent = 'All';
      allBtn.className = currentSubCategory === '' ? 'subcategory-btn selected' : 'subcategory-btn';
      allBtn.onclick = () => {
        currentSubCategory = '';
        selectedSizes.clear();
        document.getElementById('sort-select').value = 'default';
        renderFilterSizes(); 
        renderProducts();
        renderSubcategories();
      };
      container.appendChild(allBtn);

      subs.forEach(sub => {
        const btn = document.createElement('button');
        btn.textContent = sub;
        btn.className = sub === currentSubCategory ? 'subcategory-btn selected' : 'subcategory-btn';
        btn.onclick = () => {
          currentSubCategory = sub;
          selectedSizes.clear();
          document.getElementById('sort-select').value = 'default';
          renderFilterSizes(); 
          renderProducts();
          renderSubcategories();
        };
        container.appendChild(btn);
      });
    }

    // Render size filter checkboxes based on currently filtered products
    function renderFilterSizes() {
      const container = document.getElementById('size-filters');
      container.innerHTML = '';

      // Filter products by category + subcategory first
      let filtered = allProducts.filter(p => {
        if (!p.category) return false;
        if (!p.category.startsWith(currentCategory)) return false;
        if (currentSubCategory) {
          // Check if subcategory is included after main category in category string
          // E.g. category="Women/Sarees/Pattu", currentSubCategory = "Sarees"
          return p.category.split('/').slice(1).includes(currentSubCategory);
        }
        return true;
      });

      // Extract sizes available
      const sizes = flattenSizes(filtered);
      if (sizes.length === 0) return;

      sizes.forEach(size => {
        const id = `size-filter-${size.replace(/\s+/g, '-')}`;
        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = size;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.value = size;
        checkbox.checked = selectedSizes.has(size);

        checkbox.onchange = e => {
          if (e.target.checked) selectedSizes.add(size);
          else selectedSizes.delete(size);
          renderProducts();
        };

        label.prepend(checkbox);
        container.appendChild(label);
      });
    }

    // Sort products array according to currentSort
    function sortProducts(products) {
      switch(currentSort) {
        case 'price-asc':
          return products.sort((a, b) => a.price - b.price);
        case 'price-desc':
          return products.sort((a, b) => b.price - a.price);
        case 'name-asc':
          return products.sort((a, b) => a.name.localeCompare(b.name));
        case 'name-desc':
          return products.sort((a, b) => b.name.localeCompare(a.name));
        default:
          return products;
      }
    }

    // Render filtered + sorted products grid
    function renderProducts() {
      const container = document.getElementById('product-list');
      container.innerHTML = '';

      let filtered = allProducts.filter(p => {
        if (!p.category) return false;
        if (!p.category.startsWith(currentCategory)) return false;

        if (currentSubCategory) {
          // Match subcategory after main category
          if (!p.category.split('/').slice(1).includes(currentSubCategory)) {
            return false;
          }
        }

        // Filter size if any size selected
        if (selectedSizes.size > 0 && Array.isArray(p.sizes)) {
          const hasSize = p.sizes.some(s => selectedSizes.has(s));
          if (!hasSize) return false;
        }

        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<p>No products match the selected filters.</p>';
        return;
      }

      filtered = sortProducts(filtered);

      filtered.forEach(product => {
        container.appendChild(createProductCard(product));
      });
    }

    async function fetchJson(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to load ${url}`);
        return await res.json();
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    async function loadDataAndRender() {
      currentCategory = getCategoryFromUrl() || '';

      if (!currentCategory) {
        document.getElementById('category-title').textContent = 'No Category Selected';
        document.getElementById('category-description').textContent = 'Please select a category from the home page.';
        return;
      }

      document.getElementById('category-title').textContent = 'Loading...';
      document.getElementById('category-description').textContent = '';
      document.getElementById('product-list').innerHTML = '';
      document.getElementById('subcategory-nav').innerHTML = '';
      document.getElementById('size-filters').innerHTML = '';

      // Fetch all necessary data
      const [headers, products, subs] = await Promise.all([
        fetchJson('categoryHeaders.json'),
        fetchJson('products.json'),
        fetchJson('subCategories.json'),
      ]);

      categoryHeaders = headers || {};
      allProducts = products || [];
      subCategories = subs || {};

      // Show category header info
      document.getElementById('category-title').textContent = categoryHeaders[currentCategory]?.title || currentCategory;
      document.getElementById('category-description').textContent = categoryHeaders[currentCategory]?.text || '';

      // Initialize UI
      currentSubCategory = '';
      selectedSizes.clear();
      currentSort = 'default';
      document.getElementById('sort-select').value = currentSort;

      renderSubcategories();
      renderFilterSizes();
      renderProducts();
    }

    // Event listeners for sorting
    window.addEventListener('DOMContentLoaded', () => {
      loadDataAndRender();

      const sortSelect = document.getElementById('sort-select');
      sortSelect.addEventListener('change', e => {
        currentSort = e.target.value;
        renderProducts();
      });
    });
  </script>
</body>
</html>
